<div class="task-details-layout">
    <!-- Left Panel: Content -->
    <div class="left-panel">
        <!-- Fixed Top Section -->
        <div class="fixed-top-section">
            <div class="planning-header">
                <a routerLink="/planning-tasks" class="back-link">
                    <lucide-icon name="chevron-left" [size]="16"></lucide-icon>
                    <span class="ms-1">Transaction List</span>
                </a>
                <h1 class="dashboard-title">Task Details</h1>
                <!-- <p class="dashboard-subtitle">Here's a summary of your visitor activity and trends.</p> -->
            </div>

            <!-- Stepper -->
            <div class="stepper-container mb-3 mt-2" *ngIf="!isExpanded">
                <div class="step-item-wrapper" *ngFor="let step of steps; let i = index; let last = last">
                    <div class="step-item" [class.completed]="step.status === 'completed'"
                        [class.ongoing]="step.status === 'ongoing'" [class.pending]="step.status === 'pending'">

                        <div class="step-icon">
                            <img *ngIf="step.status === 'completed'" src="assets/step-icon-cmp.svg" alt="Completed">
                            <img *ngIf="step.status === 'ongoing'" src="assets/step-icon-cnt.svg" alt="Ongoing">
                            <img *ngIf="step.status === 'pending'" src="assets/step-icon-cup.svg" alt="Pending">
                        </div>
                        <span class="step-label">{{ step.label }}</span>
                    </div>
                    <div class="step-line" *ngIf="!last" [class.line-completed]="step.status === 'completed'"
                        [class.line-ongoing]="step.status === 'ongoing'"
                        [class.line-pending]="step.status === 'pending'">
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-2" *ngIf="!isExpanded">
                <div class="segmented-control">
                    <div *ngFor="let option of ['Transaction - Process', 'Attachments', 'Emails', 'Request Workflows']; let i = index"
                        class="segmented-item" [class.active]="activeTab === option"
                        [class.active-prev]="i < 3 && activeTab === ['Transaction - Process', 'Attachments', 'Emails', 'Request Workflows'][i+1]"
                        (click)="activeTab = option">
                        {{ option }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Details Area -->
        <div class="details-card-wrapper position-relative">
            <!-- Loading Overlay -->
            <div class="details-loader-overlay" *ngIf="loading">
                <div class="loader-spinner"></div>
            </div>

            <!-- Expand/Collapse Button -->
            <button class="expand-toggle-btn" (click)="toggleExpand()" [title]="isExpanded ? 'Collapse' : 'Expand'">
                <lucide-icon name="minimize-2" [size]="16" *ngIf="isExpanded"></lucide-icon>
                <lucide-icon name="maximize-2" [size]="16" *ngIf="!isExpanded"></lucide-icon>
            </button>
            <div class="details-card-scroll">
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="details-label">Area Type:</label>
                        <div class="details-value blue-text">{{ details?.areaType }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Land Type:</label>
                        <div class="details-value blue-text">{{ details?.landType }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Initiated By:</label>
                        <div class="details-value blue-text">{{ details?.initiatedBy }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Approved By:</label>
                        <div class="details-value blue-text">{{ details?.approvedBy }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Planning Status:</label>
                        <div><span class="status-badge processing">{{ details?.planningStatus }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Temporal Status:</label>
                        <div><span class="status-badge new">{{ details?.temporalStatus }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">Construction Status:</label>
                        <div><span class="status-badge new">{{ details?.constructionStatus }}</span></div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="details-label">Old Plot Area (m²):</label>
                        <div class="details-value blue-text font-weight-bold">{{ details?.oldPlotArea }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="details-label">New Plot Area (m²):</label>
                        <div class="details-value blue-text font-weight-bold">{{ details?.newPlotArea }}</div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <button class="btn btn-primary">Update Attributes</button>
                </div>

                <div class="divider mb-4"></div>

                <div class="row mb-4">
                    <div class="col-12 col-md-6">
                        <label class="details-label mb-2">Assign To</label>
                        <div class="dropdown-wrapper">
                            <select class="form-select" [(ngModel)]="selectedAssignee">
                                <option [ngValue]="null">Select Assignee</option>
                                <option *ngFor="let user of assignees" [value]="user">{{ user }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Footer inside Card -->
            <div class="details-card-footer">
                <div class="action-footer">
                    <div class="footer-left d-flex gap-2">
                        <button class="btn btn-success btn-sm"><lucide-icon name="check" size="16"></lucide-icon>
                            Approve</button>
                        <button class="btn btn-danger btn-sm"><lucide-icon name="x" size="16"></lucide-icon>
                            Reject</button>
                    </div>
                    <div class="footer-right d-flex gap-2">
                        <button class="btn btn-primary btn-sm"><lucide-icon name="rotate-ccw" size="16"></lucide-icon>
                            Return</button>
                        <button class="btn btn-warning text-white btn-sm"><lucide-icon name="x-circle"
                                size="16"></lucide-icon>
                            Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel: Map -->
    <div class="right-panel" [class.fullscreen]="isFullScreen" [style.width.%]="isFullScreen ? 100 : rightPanelWidth">
        <!-- Resizer Handle (Inside Right Panel now) -->
        <div class="resizer" (mousedown)="startResizing($event)">
            <div class="resizer-knob"></div>
        </div>

        <div class="map-placeholder" id="map" [class.resizing]="isResizing">
            <iframe
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d116130.63855562769!2d54.25624838665046!3d24.475458099999998!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3e5e440f7d544839%3A0xe54724b07c8da1c7!2sAbu%20Dhabi!5e0!3m2!1sen!2sae!4v1707328637725!5m2!1sen!2sae"
                width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"></iframe>
            <div class="map-overlay-buttons">
                <button class="btn btn-primary btn-icon" (click)="toggleFullScreen()"
                    [title]="isFullScreen ? 'Exit Full Screen' : 'Full Screen'">
                    <lucide-icon [name]="isFullScreen ? 'minimize-2' : 'maximize-2'" size="18"></lucide-icon>
                </button>
                <button class="btn btn-primary btn-icon"><lucide-icon name="layers" size="18"></lucide-icon></button>
                <button class="btn btn-primary btn-icon"><lucide-icon name="map" size="18"></lucide-icon></button>
                <button class="btn btn-primary btn-icon"><lucide-icon name="route" size="18"></lucide-icon></button>
            </div>
        </div>
    </div>
</div>